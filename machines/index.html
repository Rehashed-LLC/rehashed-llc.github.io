
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>North Star Metrics Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #0a0a0a;
        color: #e0e0e0;
        overflow-x: hidden;
    }
    
    #canvas-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
    }
    
    .dashboard-container { 
        position: relative;
        z-index: 1;
        max-width: 1400px; 
        margin: 0 auto;
        padding: 40px 30px;
    }
    
    .controls { 
        display: flex; 
        gap: 20px; 
        margin-bottom: 40px;
        background: rgba(20, 20, 20, 0.7);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .controls > div {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .controls label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #888;
    }
    
    .controls input, .controls select {
        background: rgba(40, 40, 40, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: #e0e0e0;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
    }
    
    .controls button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 10px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
        align-self: flex-end;
    }
    
    .controls button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    .chart-container {
        background: rgba(20, 20, 20, 0.7);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 30px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .chart-title {
        font-size: 20px;
        font-weight: 600;
        color: #fff;
        letter-spacing: -0.5px;
    }
    
    .legend {
        display: flex;
        gap: 20px;
        font-size: 13px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
    }
    
    svg { 
        width: 100%; 
        height: 320px;
    }
    
    .axis line, .axis path {
        stroke: rgba(255, 255, 255, 0.2);
    }
    
    .axis text {
        fill: #888;
        font-size: 11px;
    }
    
    .tooltip {
        position: absolute;
        padding: 10px 14px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        border-radius: 8px;
        font-size: 13px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }
</style>

</head>
<body>
    

<div id="canvas-container"></div>

<div class="dashboard-container">

<!-- Controls -->

<div class="controls">
    <div>
        <label>Date Range</label>
        <div style="display: flex; gap: 10px;">
            <input type="date" id="startDate" value="2025-01-01">
            <input type="date" id="endDate" value="2025-01-30">
        </div>
    </div>
    <div>
        <label>Granularity</label>
        <select id="granularity">
            <option value="daily" selected>Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
        </select>
    </div>
    <button id="reload">Reload Data</button>
</div>

<!-- CHARTS -->

<div class="chart-container">
    <div class="chart-header">
        <div class="chart-title">Active Users (30 Day)</div>
    </div>
    <svg id="chart-au"></svg>
</div>

<div class="chart-container">
    <div class="chart-header">
        <div class="chart-title">Gross Merchandise Volume</div>
    </div>
    <svg id="chart-gmv"></svg>
</div>

<div class="chart-container">
    <div class="chart-header">
        <div class="chart-title">Subscription Revenue</div>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #ff6e6e;"></div>
                <span>Pro</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffa54b;"></div>
                <span>Hobby</span>
            </div>
        </div>
    </div>
    <svg id="chart-sub"></svg>
</div>

<div class="chart-container">
    <div class="chart-header">
        <div class="chart-title">User Retention</div>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #2ecc71;"></div>
                <span>30 Day</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #1abc9c;"></div>
                <span>90 Day</span>
            </div>
        </div>
    </div>
    <svg id="chart-ret"></svg>
</div>

<div class="chart-container">
    <div class="chart-header">
        <div class="chart-title">Contribution Margin per Active User</div>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #4c9cff;"></div>
                <span>Revenue</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff7f7f;"></div>
                <span>Costs</span>
            </div>
        </div>
    </div>
    <svg id="chart-cmpau"></svg>
</div>

</div>

<div id="tooltip" class="tooltip"></div>

<script>
// ------------------------------------------------------
// THREE.JS BACKGROUND ANIMATION (from rehashed.work)
// ------------------------------------------------------
(function() {
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x000000, 1);
    container.appendChild(renderer.domElement);
    
    camera.position.z = 5;
    
    // Create particles
    const particlesGeometry = new THREE.BufferGeometry();
    const particlesCount = 5000;
    const posArray = new Float32Array(particlesCount * 3);
    
    for(let i = 0; i < particlesCount * 3; i++) {
        posArray[i] = (Math.random() - 0.5) * 10;
    }
    
    particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
    
    const particlesMaterial = new THREE.PointsMaterial({
        size: 0.005,
        color: 0x667eea,
        transparent: true,
        opacity: 0.8,
        blending: THREE.AdditiveBlending
    });
    
    const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
    scene.add(particlesMesh);
    
    // Mouse interaction
    let mouseX = 0;
    let mouseY = 0;
    
    document.addEventListener('mousemove', (e) => {
        mouseX = e.clientX / window.innerWidth - 0.5;
        mouseY = e.clientY / window.innerHeight - 0.5;
    });
    
    // Animation
    let frame = 0;
    function animate() {
        requestAnimationFrame(animate);
        frame += 0.001;
        
        particlesMesh.rotation.y = frame + mouseX * 0.5;
        particlesMesh.rotation.x = frame * 0.5 + mouseY * 0.5;
        
        // Animate particles
        const positions = particlesMesh.geometry.attributes.position.array;
        for(let i = 0; i < positions.length; i += 3) {
            positions[i + 1] = Math.sin(frame + positions[i]) * 0.5;
        }
        particlesMesh.geometry.attributes.position.needsUpdate = true;
        
        renderer.render(scene, camera);
    }
    
    animate();
    
    // Resize handler
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
})();

// ------------------------------------------------------
// MOCK DATA GENERATION - regenerates based on date range
// ------------------------------------------------------
function generateMockData(startDate, endDate) {
    const mockData = [];
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    let currentDate = new Date(start);
    
    while (currentDate <= end) {
        const dateStr = currentDate.toISOString().split('T')[0];
        const pro = Math.random() * 9000 + 3000;
        const hobby = Math.random() * 4000 + 1000;

        mockData.push({
            date: dateStr,
            active_users_30d: Math.floor(Math.random() * 3000 + 1500),
            spending_volume: Math.random() * 150000 + 50000,
            subscription_pro: pro,
            subscription_hobby: hobby,
            retention_30: 0.4 + Math.random() * 0.5,
            retention_90: 0.2 + Math.random() * 0.4,
            cmpau_revenue: Math.random() * 30 + 10,
            cmpau_costs: Math.random() * 12 + 4
        });
        
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    return mockData;
}

// ------------------------------------------------------
// Helpers
// ------------------------------------------------------
function resample(data, gran) {
  if (gran === "daily") return data;

  const keyFn = {
    weekly: d => d.date.slice(0, 7) + "-W" + Math.floor(new Date(d.date).getDate()/7),
    monthly: d => d.date.slice(0, 7)
  }[gran];

  const grouped = d3.group(data, keyFn);
  const out = [];

  for (const [k, rows] of grouped) {
    out.push({
      date: k,
      active_users_30d: d3.max(rows, r => r.active_users_30d),
      spending_volume: d3.sum(rows, r => r.spending_volume),
      subscription_pro: d3.sum(rows, r => r.subscription_pro),
      subscription_hobby: d3.sum(rows, r => r.subscription_hobby),
      retention_30: d3.mean(rows, r => r.retention_30),
      retention_90: d3.mean(rows, r => r.retention_90),
      cmpau_revenue: d3.sum(rows, r => r.cmpau_revenue),
      cmpau_costs: d3.sum(rows, r => r.cmpau_costs)
    });
  }

  return out;
}

const tooltip = d3.select("#tooltip");

function showTooltip(content, x, y) {
  tooltip.html(content)
         .style("left", (x + 15) + "px")
         .style("top", (y - 10) + "px")
         .style("opacity", 1);
}
function hideTooltip() { tooltip.style("opacity", 0); }

// ------------------------------------------------------
// ACTIVE USERS — AREA CHART
// ------------------------------------------------------
function chartActiveUsers(svgId, data) {
  const svg = d3.select(svgId);
  svg.selectAll("*").remove();

  const w = svg.node().clientWidth;
  const h = svg.node().clientHeight;
  const M = {t:20,r:20,b:40,l:50};

  const x = d3.scaleBand().domain(data.map(d => d.date)).range([M.l, w-M.r]).padding(0.1);
  const y = d3.scaleLinear().domain([0, d3.max(data, d => d.active_users_30d)]).nice()
              .range([h-M.b, M.t]);

  // gradient
  const defs = svg.append("defs");
  const gradient = defs.append("linearGradient")
    .attr("id","areaGrad")
    .attr("x1","0").attr("y1","0")
    .attr("x2","0").attr("y2","1");
  gradient.append("stop").attr("offset","0%").attr("stop-color","#4e8cff80");
  gradient.append("stop").attr("offset","100%").attr("stop-color","#4e8cff05");

  const line = d3.line()
     .x(d => x(d.date) + x.bandwidth()/2)
     .y(d => y(d.active_users_30d))
     .curve(d3.curveMonotoneX);

  const area = d3.area()
     .x(d => x(d.date) + x.bandwidth()/2)
     .y0(h-M.b)
     .y1(d => y(d.active_users_30d))
     .curve(d3.curveMonotoneX);

  svg.append("path").datum(data)
     .attr("fill","url(#areaGrad)")
     .attr("d",area);

  svg.append("path").datum(data)
     .attr("fill","none")
     .attr("stroke","#4e8cff")
     .attr("stroke-width",3)
     .attr("d",line);

  // dots with tooltip
  svg.selectAll("circle")
     .data(data)
     .enter().append("circle")
     .attr("cx", d => x(d.date)+x.bandwidth()/2)
     .attr("cy", d => y(d.active_users_30d))
     .attr("r",4)
     .attr("fill","#4e8cff")
     .on("mousemove",(e,d)=>{
        showTooltip(`Active Users: <b>${d.active_users_30d}</b><br>${d.date}`, e.pageX, e.pageY);
     })
     .on("mouseout", hideTooltip);

  // axes
  svg.append("g")
     .attr("class", "axis")
     .attr("transform",`translate(0,${h-M.b})`)
     .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i)=>!(i%Math.ceil(data.length/8)))));

  svg.append("g")
     .attr("class", "axis")
     .attr("transform",`translate(${M.l},0)`)
     .call(d3.axisLeft(y));
}

// ------------------------------------------------------
// GMV — BAR CHART
// ------------------------------------------------------
function chartGMV(svgId, data) {
  const svg = d3.select(svgId);
  svg.selectAll("*").remove();

  const w = svg.node().clientWidth;
  const h = svg.node().clientHeight;
  const M = {t:20,r:20,b:40,l:60};

  const x = d3.scaleBand().domain(data.map(d => d.date)).range([M.l, w-M.r]).padding(0.15);
  const y = d3.scaleLinear().domain([0, d3.max(data, d => d.spending_volume)]).nice()
              .range([h-M.b, M.t]);

  svg.selectAll("rect")
     .data(data)
     .enter().append("rect")
     .attr("x", d => x(d.date))
     .attr("y", d => y(d.spending_volume))
     .attr("width", x.bandwidth())
     .attr("height", d => h-M.b - y(d.spending_volume))
     .attr("fill","#7d5eff")
     .on("mousemove", (e,d)=> {
        showTooltip(`GMV: <b>$${d.spending_volume.toLocaleString()}</b><br>${d.date}`, e.pageX, e.pageY);
     })
     .on("mouseout", hideTooltip);

  svg.append("g")
     .attr("class", "axis")
     .attr("transform",`translate(0,${h-M.b})`)
     .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i)=>!(i%Math.ceil(data.length/8)))));

  svg.append("g")
     .attr("class", "axis")
     .attr("transform",`translate(${M.l},0)`)
     .call(d3.axisLeft(y).tickFormat(d => "$" + d3.format(",.0f")(d)));
}

// ------------------------------------------------------
// SUBSCRIPTION — STACKED BAR
// ------------------------------------------------------
function chartSubs(svgId, data) {
  const svg = d3.select(svgId);
  svg.selectAll("*").remove();

  const w = svg.node().clientWidth;
  const h = svg.node().clientHeight;
  const M = {t:20,r:20,b:40,l:60};

  const keys = ["subscription_pro","subscription_hobby"];

  const x = d3.scaleBand().domain(data.map(d => d.date)).range([M.l, w-M.r]).padding(0.15);
  const y = d3.scaleLinear()
              .domain([0, d3.max(data, d => d.subscription_pro + d.subscription_hobby)]).nice()
              .range([h-M.b, M.t]);

  const colors = d3.scaleOrdinal()
      .domain(keys)
      .range(["#ff6e6e","#ffa54b"]);

  const stacked = d3.stack().keys(keys)(data);

  svg.selectAll("g.series")
     .data(stacked)
     .enter().append("g")
     .attr("fill", d => colors(d.key))
     .selectAll("rect")
     .data(d => d)
     .enter().append("rect")
     .attr("x", d => x(d.data.date))
     .attr("y", d => y(d[1]))
     .attr("height", d => y(d[0]) - y(d[1]))
     .attr("width", x.bandwidth())
     .on("mousemove",(e,d)=>{
        const total = d.data.subscription_pro + d.data.subscription_hobby;
        showTooltip(`
          <b>${d.data.date}</b><br>
          Pro: $${d.data.subscription_pro.toFixed(0)}<br>
          Hobby: $${d.data.subscription_hobby.toFixed(0)}<br>
          <b>Total: $${total.toFixed(0)}</b>
        `, e.pageX, e.pageY);
     })
     .on("mouseout", hideTooltip);

  svg.append("g")
     .attr("class", "axis")
     .attr("transform",`translate(0,${h-M.b})`)
     .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i)=>!(i%Math.ceil(data.length/8)))));

  svg.append("g")
     .attr("class", "axis")
     .attr("transform",`translate(${M.l},0)`)
     .call(d3.axisLeft(y));
}

// ------------------------------------------------------
// RETENTION — SMOOTH LINE (S-CURVE STYLE)
// ------------------------------------------------------
function chartRetention(svgId, data) {
  const svg = d3.select(svgId);
  svg.selectAll("*").remove();

  const w = svg.node().clientWidth;
  const h = svg.node().clientHeight;
  const M = {t:20,r:20,b:40,l:50};

  const x = d3.scaleBand().domain(data.map(d => d.date)).range([M.l, w-M.r]).padding(0.1);
  const y = d3.scaleLinear().domain([0,1]).range([h-M.b, M.t]);

  const line30 = d3.line()
    .x(d => x(d.date)+x.bandwidth()/2)
    .y(d => y(d.retention_30))
    .curve(d3.curveMonotoneX);

  const line90 = d3.line()
    .x(d => x(d.date)+x.bandwidth()/2)
    .y(d => y(d.retention_90))
    .curve(d3.curveMonotoneX);

  svg.append("path").datum(data)
    .attr("d", line30)
    .attr("stroke", "#2ecc71")
    .attr("stroke-width", 3)
    .attr("fill", "none");

  svg.append("path").datum(data)
    .attr("d", line90)
    .attr("stroke", "#1abc9c")
    .attr("stroke-width", 3)
    .attr("fill", "none");

  svg.selectAll("circle.r30")
    .data(data)
    .enter().append("circle")
    .attr("class","r30")
    .attr("cx", d => x(d.date)+x.bandwidth()/2)
    .attr("cy", d => y(d.retention_30))
    .attr("r",4)
    .attr("fill","#2ecc71")
    .on("mousemove",(e,d)=>{
       showTooltip(`30d retention: <b>${(d.retention_30*100).toFixed(1)}%</b>`, e.pageX, e.pageY);
    })
    .on("mouseout", hideTooltip);

  svg.selectAll("circle.r90")
    .data(data)
    .enter().append("circle")
    .attr("class","r90")
    .attr("cx", d => x(d.date)+x.bandwidth()/2)
    .attr("cy", d => y(d.retention_90))
    .attr("r",4)
    .attr("fill","#1abc9c")
    .on("mousemove",(e,d)=>{
       showTooltip(`90d retention: <b>${(d.retention_90*100).toFixed(1)}%</b>`, e.pageX, e.pageY);
    })
    .on("mouseout", hideTooltip);

  svg.append("g")
     .attr("class", "axis")
     .attr("transform",`translate(0,${h-M.b})`)
     .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i)=>!(i%Math.ceil(data.length/8)))));

  svg.append("g")
     .attr("class", "axis")
     .attr("transform",`translate(${M.l},0)`)
     .call(d3.axisLeft(y).tickFormat(d=> (d*100)+"%"));
}

// ------------------------------------------------------
// CONTRIBUTION MARGIN — STACKED BAR
// ------------------------------------------------------
function chartCMPAU(svgId, data) {
  const svg = d3.select(svgId);
  svg.selectAll("*").remove();

  const w = svg.node().clientWidth;
  const h = svg.node().clientHeight;
  const M = {t:20,r:20,b:40,l:60};

  const keys = ["cmpau_revenue","cmpau_costs"];

  const x = d3.scaleBand().domain(data.map(d => d.date)).range([M.l, w-M.r]).padding(0.15);
  const y = d3.scaleLinear()
              .domain([0, d3.max(data, d => d.cmpau_revenue + d.cmpau_costs)]).nice()
              .range([h-M.b, M.t]);

  const colors = d3.scaleOrdinal().domain(keys).range(["#4c9cff","#ff7f7f"]);

  const stacked = d3.stack().keys(keys)(data);

  svg.selectAll("g.series")
     .data(stacked)
     .enter().append("g")
     .attr("fill", d => colors(d.key))
     .selectAll("rect")
     .data(d => d)
     .enter().append("rect")
     .attr("x", d => x(d.data.date))
     .attr("y", d => y(d[1]))
     .attr("height", d => y(d[0]) - y(d[1]))
     .attr("width", x.bandwidth())
     .on("mousemove",(e,d)=>{
        showTooltip(`
          <b>${d.data.date}</b><br>
          Revenue: $${d.data.cmpau_revenue.toFixed(1)}<br>
          Costs: $${d.data.cmpau_costs.toFixed(1)}<br>
          <b>Margin: ${(d.data.cmpau_revenue-d.data.cmpau_costs).toFixed(1)}</b>
        `, e.pageX, e.pageY);
     })
     .on("mouseout", hideTooltip);

  svg.append("g")
     .attr("class", "axis")
     .attr("transform",`translate(0,${h-M.b})`)
     .call(d3.axisBottom(x).tickValues(x.domain().filter((d,i)=>!(i%Math.ceil(data.length/8)))));

  svg.append("g")
     .attr("class", "axis")
     .attr("transform",`translate(${M.l},0)`)
     .call(d3.axisLeft(y));
}

// ------------------------------------------------------
// Render the full dashboard
// ------------------------------------------------------
function render() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  const gran = document.getElementById("granularity").value;

  const mockData = generateMockData(start, end);
  const data = resample(mockData, gran);

  chartActiveUsers("#chart-au", data);
  chartGMV("#chart-gmv", data);
  chartSubs("#chart-sub", data);
  chartRetention("#chart-ret", data);
  chartCMPAU("#chart-cmpau", data);
}

document.getElementById("reload").onclick = render;
render();

</script>

</body>
</html>